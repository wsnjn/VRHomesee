# 业务流程图

本文档包含系统核心业务模块的时序图，详细展示了前端、后端与数据库之间的交互流程。

## 1. 用户管理与认证流程
*涵盖功能：注册、登录、个人信息修改、头像上传*

```mermaid
sequenceDiagram
    participant User as 用户
    participant Client as 前端
    participant Server as 后端 API
    participant DB as 数据库

    Note over User, Client: 1.1 注册流程
    User->>Client: 输入用户名、手机号、密码
    Client->>Server: POST /api/user/register
    Server->>DB: 检查手机号/用户名是否重复
    alt 已存在
        DB-->>Server: 返回重复记录
        Server-->>Client: 错误：用户已存在
    else 验证通过
        Server->>DB: 创建新用户记录
        DB-->>Server: 成功
        Server-->>Client: 注册成功
    end

    Note over User, Client: 1.2 登录流程
    User->>Client: 输入凭证登录
    Client->>Server: POST /api/user/login
    Server->>DB: 验证账号密码
    alt 验证成功
        DB-->>Server: 返回用户 User 实体
        Server-->>Client: 返回登录成功 & UserInfo
    else 失败
        Server-->>Client: 错误：账号或密码错误
    end

    Note over User, Client: 1.3 个人信息管理
    User->>Client: 修改资料 / 上传头像
    Client->>Server: POST /api/user/upload-avatar (上传文件)
    Server->>Client: 返回图片 URL
    Client->>Server: PUT /api/user/update/{userId} (更新字段)
    Server->>DB: 更新 User 表
    DB-->>Server: 更新完成
    Server-->>Client: 更新成功
```

## 2. 房源管理流程 (房东端)
*涵盖功能：发布房源、VR上传、状态管理*

```mermaid
sequenceDiagram
    participant Landlord as 房东
    participant Client as 前端
    participant Server as 后端 API
    participant DB as 数据库
    participant FileServer as 文件服务器

    Note over Landlord, Client: 2.1 发布房源
    Landlord->>Client: 填写房源信息 (地址/价格/配置)
    Client->>Server: POST /api/rooms/add
    Server->>DB: 插入 RoomInfo 记录
    DB-->>Server: 返回 RoomID
    Server-->>Client: 发布成功

    Note over Landlord, Client: 2.2 上传 VR 场景
    Landlord->>Client: 选择全景图上传
    Client->>Server: POST /api/vr-scenes/upload
    Server->>FileServer: 存储图片文件
    FileServer-->>Server: 返回文件 URL
    Server->>DB: 保存 VR 场景数据 (RoomID 关联)
    DB-->>Server: 保存成功
    Server-->>Client: 上传完成

    Note over Landlord, Client: 2.3 房源状态管理
    Landlord->>Client: 下架 / 上架房源
    Client->>Server: PUT /api/landlord/house/{id}/status
    Server->>DB: 更新 status 字段
    DB-->>Server: 更新成功
    Server-->>Client: 状态修改完成
```

## 3. 租客看房与预约流程
*涵盖功能：搜索筛选、详情查看、发起预约、房东确认*

```mermaid
sequenceDiagram
    participant Tenant as 租客
    participant Client as 前端
    participant Server as 后端 API
    participant DB as 数据库
    participant LandlordClient as 房东端

    Note over Tenant, Client: 3.1 搜索房源
    Tenant->>Client: 设置筛选条件 (位置/价格/户型)
    Client->>Server: GET /api/room-info/filter
    Server->>DB: 执行多条件组合查询
    DB-->>Server: 返回房源列表
    Server-->>Client: 展示房源列表

    Note over Tenant, Client: 3.2 预约看房
    Tenant->>Client: 点击"预约看房", 选择时间
    Client->>Server: POST /api/viewing-appointment/create
    Server->>DB: 创建 Appointment (Status=待确认)
    Server->>LandlordClient: **推送新预约通知**
    Server-->>Client: 预约提交成功

    Note over LandlordClient, Server: 3.3 房东确认
    LandlordClient->>Server: 查看预约 -> 点击"接受"
    Server->>DB: 更新 Appointment (Status=已确认)
    Server->>Client: **推送确认通知给租客**
    
    Note over Tenant, Client: 3.4 线下看房与反馈
    Tenant->>Client: 看房后评价/确认
    Client->>Server: PUT /api/viewing-appointment/{id}/status (完成)
```

## 4. 租赁合同与租务管理流程
*涵盖功能：签约、支付租金、水电抄表、报修*

```mermaid
sequenceDiagram
    participant Landlord as 房东
    participant Tenant as 租客
    participant Server as 后端 API
    participant DB as 数据库

    Note over Landlord, Tenant: 4.1 签约流程
    Landlord->>Server: POST /api/landlord/matching/create (发起合同)
    Server->>DB: 创建 TenantManagement 记录
    Server->>DB: 更新 RoomInfo 状态为"已租"
    Server->>Tenant: 推送合同确认通知

    Note over Landlord, Tenant: 4.2 租金与账单
    loop 每月周期
        Server->>DB: 生成当月 RentPayment 账单
        Landlord->>Server: POST /meter-readings (录入水电)
        Server->>DB: 更新账单金额
        Server->>Tenant: 推送缴费提醒
        Tenant->>Server: PUT /rent-status (支付完成)
        Server->>DB: 更新 Payment 状态为"已支付"
    end

    Note over Landlord, Tenant: 4.3 报修流程
    Tenant->>Server: POST /api/maintenance/create (提交报修)
    Server->>DB: 创建 MaintenanceRequest
    Server->>Landlord: 通知房东维修
    Landlord->>Server: POST /api/maintenance/update (更新维修进度/费用)
    Server->>DB: 记录维修结果
```

## 5. 社区社交与 AI 助手
*涵盖功能：发帖、评论、点赞、聊天、AI 对话*

```mermaid
sequenceDiagram
    participant User as 用户
    participant Server as 后端 API
    participant DB as 数据库
    participant AI as AI 服务

    Note over User, Server: 5.1 社区互动
    User->>Server: POST /api/community/posts/create (发帖)
    Server->>DB: 保存帖子 & 媒体链接
    User->>Server: POST /posts/{id}/comment (评论)
    User->>Server: POST /posts/{id}/like (点赞)
    Server->>DB: 更新互动数据

    Note over User, Server: 5.2 即时通讯 (IM)
    User->>Server: POST /api/community/messages/send
    Server->>DB: 保存 ChatMessage
    Server->>User: (WebSocket/轮询) 推送消息给接收方

    Note over User, Server: 5.3 AI 智能助手
    User->>Server: POST /api/smart-matching/chat (发送问题)
    Server->>DB: 保存用户提问
    Server->>AI: 调用大模型接口 (RAG 检索房源)
    AI-->>Server: 返回 AI 回答 (推荐房源/解答疑问)
    Server->>DB: 保存 AI 回答
    Server-->>User: 返回 AI 响应
```

## 6. 管理员后台管理流程
*涵盖功能：用户管理、社区管控、全局统计*

```mermaid
sequenceDiagram
    participant Admin as 管理员
    participant Server as 后端 API
    participant DB as 数据库

    Note over Admin, Server: 6.1 用户管控
    Admin->>Server: GET /api/admin/user/all
    Server->>DB: 查询所有用户
    Admin->>Server: PUT /api/admin/user/{id}/reset-password
    DB-->>Server: 密码重置完成

    Note over Admin, Server: 6.2 社区治理
    Admin->>Server: POST /api/admin/channel/chat/mute (禁言)
    Admin->>Server: POST /api/admin/channel/community/ban (封禁发帖)
    Server->>DB: 更新用户状态/黑名单
    DB-->>Server: 操作生效
```
